# Документация по конвертеру архитектурных данных

Этот документ описывает Python-скрипт, предназначенный для конвертации данных технической архитектуры из исходного формата `cloud.ru/advanced/` в целевой формат метамодели `seaf-core/entities/ta/`.

## 1. Введение

Конвертер разработан для автоматизации процесса преобразования описаний инфраструктурных компонентов и сервисов, полученных из облачной платформы Cloud.ru, в унифицированный формат, используемый в архитектурном фреймворке SEAF. Это позволяет интегрировать данные из различных источников в единую архитектурную модель.

## 2. Использование

Скрипт `converter.py` запускается из командной строки и поддерживает следующие аргументы:

*   `--input-dir <path>`: Путь к директории, содержащей исходные YAML-файлы с описанием архитектуры Cloud.ru. По умолчанию: `architecture/ta/reverse/cloud.ru/advanced/`.
*   `--output-dir <path>`: Путь к директории, куда будут сохраняться сконвертированные YAML-файлы в формате SEAF-core. По умолчанию: `architecture/ta/converted/`.
*   `--config <path>`: Путь к файлу конфигурации `converter_config.yaml`. По умолчанию: `converter_config.yaml` (в той же директории, что и `converter.py`).
*   `<entities>`: Список конкретных сущностей для конвертации, перечисленных через пробел (например, `vpcs subnets ecss`). Если этот аргумент указан, он переопределяет список сущностей из файла конфигурации.

**Примеры запуска:**

*   **Конвертировать все сущности (по умолчанию):**
    ```bash
    python3 converter.py
    ```
*   **Конвертировать только VPC и Subnets, указав директории:**
    ```bash
    python3 converter.py --input-dir /path/to/source_data/ --output-dir /path/to/target_data/ vpcs subnets
    ```
*   **Использовать пользовательский файл конфигурации:**
    ```bash
    python3 converter.py --config my_custom_config.yaml
    ```

## 3. Конфигурация

Конвертер использует файл `converter_config.yaml` для определения настроек по умолчанию. Пример содержимого файла:

```yaml
# Default configuration for the converter script

# Input directory containing the source architecture files (e.g., from reverse engineering)
input_dir: 'architecture/ta/reverse/cloud.ru/advanced/'

# Output directory for the converted seaf-core entities
output_dir: 'architecture/ta/converted/'

# List of entities to convert.
# Use '__all__' to convert all supported entities.
# Example: ['vpcs', 'subnets', 'ecss']
entities_to_convert:
  - '__all__'
```

## 4. Поддерживаемые сущности и маппинг

Конвертер поддерживает преобразование следующих сущностей из формата Cloud.ru в формат SEAF-core:

| Исходная сущность (Cloud.ru) | Целевая сущность (SEAF-core) | Описание маппинга |
| :--------------------------- | :--------------------------- | :---------------- |
| `dcs`                        | `seaf.ta.services.dc`        | **Новое:** ЦОД создается для каждой уникальной зоны доступности (AZ). Имя и адрес ЦОДа соответствуют имени AZ. |
| `vpcs`                       | `seaf.ta.services.network_segment`, `seaf.ta.components.network` | VPC преобразуется в сетевой сегмент и виртуальный маршрутизатор, размещённый в соответствующем ЦОД (`location`) и подключённый к дочернему сегменту и сетям, попадающим в CIDR VPC. |
| `subnets`                    | `seaf.ta.services.network`   | Подсеть преобразуется в сеть типа "LAN". |
| `ecss`                       | `seaf.ta.components.server`  | Виртуальные машины преобразуются в серверы типа "Виртуальный". Местоположение (`location`) сервера определяется его зоной доступности (AZ). |
| `cces`                       | `seaf.ta.services.k8s`       | Кластеры Kubernetes преобразуются в сущности K8s. |
| `rdss`                       | `seaf.ta.services.cluster`   | Реляционные БД как сервис преобразуются в кластеры типа "СУБД". |
| `elbs`                       | `seaf.ta.components.network` | Балансировщики нагрузки преобразуются в сетевые устройства типа "Балансировщик"; `location` берётся из AZ связанной подсети. |
| `nat_gateways`               | `seaf.ta.components.network` | NAT-шлюзы преобразуются в сетевые устройства типа "NAT" с `location`, вычисленным по AZ подсети. |
| `peerings`                   | `seaf.ta.services.network_links` | VPC Peering преобразуется в сетевую связь. |
| `vaults`                     | `seaf.ta.services.storage` и `seaf.ta.services.backup` | Хранилища резервных копий преобразуются в сущности хранения и отдельные сущности резервных копий. |
| `vpn_gateways`               | `seaf.ta.components.network` | VPN-шлюзы преобразуются в сетевые устройства типа "VPN" с `location`, рассчитанным по AZ подключённой подсети. |
| `vpn_connections`            | `seaf.ta.services.network_links` | VPN-соединения преобразуются в сетевые связи. |
| `eips`                       | `seaf.ta.services.network`, `seaf.ta.services.network_links`, `seaf.ta.services.network_segment` | Elastic IP преобразуются в сети типа "WAN", подключаются к интернет-сегментам по каждому ЦОДу и создают сетевые связи к внутренним ресурсам по `int_address`. |
| `dmss`                       | `seaf.ta.services.cluster`   | Сервисы сообщений преобразуются в кластеры типа "Интеграционная шина". |
| `security_groups`            | `seaf.ta.services.kb`        | Группы безопасности преобразуются в сущности Базы знаний (KB) с тегом "FW". |
| `branches`                   | `seaf.ta.services.office`    | Филиалы преобразуются в офисы. |

Более детальная информация о логике маппинга каждого поля доступна в документе `_metamodel_/iaas/converter/mapping_analysis.md`.

## 5. Расширяемость

Для добавления поддержки новых сущностей или изменения логики конвертации:

1.  **Создайте новый модуль конвертера:** В директории `modules/` создайте файл `[entity_name]_converter.py` (например, `new_entity_converter.py`).
2.  **Реализуйте функцию `convert`:** Внутри этого модуля определите функцию `convert(source_data)`, которая принимает полный словарь исходных данных и возвращает словарь сконвертированных данных.
3.  **Добавьте импорт и регистрацию:** В файле `converter.py` добавьте импорт вашего нового модуля и зарегистрируйте его функцию `convert` в словаре `CONVERTERS`.
4.  **Напишите тесты:** В директории `tests/` создайте `test_[entity_name]_converter.py` для проверки корректности работы вашего конвертера.

## 6. Аналитическая сводка

После завершения работы скрипт выводит аналитическую сводку, которая включает:

*   Количество обнаруженных исходных сущностей каждого типа.
*   Количество успешно сконвертированных целевых сущностей каждого типа.
*   Список сущностей, для которых не был найден конвертер.
*   Список сущностей, конвертация которых завершилась ошибкой, с указанием причины.

Эта сводка помогает быстро оценить полноту и успешность процесса конвертации.

## 7. Устранение неполадок

*   **`TypeError: unhashable type: 'dict'`:** Убедитесь, что в коде конвертера не используются `{{}}` вместо `{}` для инициализации пустых словарей.
*   **`AttributeError: 'module' object has no attribute 'convert'`:** Проверьте, что функция `convert` корректно определена в модуле конвертера и что она не имеет синтаксических ошибок.
*   **Несоответствие данных в тестах:** Используйте `print(converted_data)` в тестовом файле для сравнения фактического вывода с ожидаемым. Обращайте внимание на порядок элементов в списках/словарях и форматирование строк (например, символы новой строки).
*   **Файлы перезаписываются вместо слияния:** Убедитесь, что `save_converted_data` корректно реализована для слияния данных, а не для перезаписи.
